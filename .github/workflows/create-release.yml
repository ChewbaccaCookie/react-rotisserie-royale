name: Deploy Server
on:
    push:
        branches:
            - master

jobs:
    create-release:
        name: "Create new release and deploy server"
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  persist-credentials: false
            - uses: actions/setup-node@v1
              with:
                  node-version: 13
                  registry-url: https://npm.onedash.dev/

            - uses: actions/cache@v1
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-node-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-node-
            - name: üèó Install dependencies
              run: npx pnpm install
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Semantic Release
              env:
                  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: npx semantic-release

            - name: "üö¶ Build server"
              run: npm run build
              
            - name: üöÄ Deploy to ftp
              uses: SamKirkland/FTP-Deploy-Action@3.1.0
              with:
                  ftp-server: ${{ secrets.FTP_SERVER }}
                  ftp-username: ${{ secrets.FTP_USERNAME }}
                  ftp-password: ${{ secrets.FTP_PASSWORD }}
                  local-dir: build/
